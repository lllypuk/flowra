# Refactoring Log

## 2025-10-18: Migration to Event Sourcing (Task Domain)

### –¶–µ–ª—å
–ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è Task domain –º–æ–¥–µ–ª–∏ —Å —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ CRUD –ø–æ–¥—Ö–æ–¥–∞ –Ω–∞ Event Sourcing –ø–∞—Ç—Ç–µ—Ä–Ω.

### –ü—Ä–æ–±–ª–µ–º–∞
–í –ø—Ä–æ–µ–∫—Ç–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–æ –¥–≤–µ –º–æ–¥–µ–ª–∏ –¥–ª—è Task:
1. **`task.go` (Entity)** - —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è CRUD –º–æ–¥–µ–ª—å —Å –∏–∑–º–µ–Ω—è–µ–º—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
2. **`aggregate.go` (Aggregate)** - Event Sourcing –º–æ–¥–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–±—ã—Ç–∏–π

–≠—Ç–æ —Å–æ–∑–¥–∞–≤–∞–ª–æ:
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏
- ‚ùå –ü—É—Ç–∞–Ω–∏—Ü—É –≤ —Ç–æ–º, –∫–∞–∫—É—é –º–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- ‚ùå –î–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤–¥—ã (–Ω–∞—Ä—É—à–µ–Ω–∏–µ Single Source of Truth)
- ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

### –†–µ—à–µ–Ω–∏–µ
–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π Entity –º–æ–¥–µ–ª–∏ –Ω–∞ Aggregate —Å Event Sourcing.

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

#### 1. –£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ–∞–π–ª—ã:
```
‚ùå internal/domain/task/task.go          (—Å—Ç–∞—Ä–∞—è Entity –º–æ–¥–µ–ª—å)
‚ùå internal/domain/task/task_test.go     (—Ç–µ—Å—Ç—ã –¥–ª—è Entity)
‚ùå internal/domain/task/repository.go    (CRUD repository –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- `task.go` - –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ Aggregate —Å Event Sourcing
- `task_test.go` - —Ç–µ—Å—Ç—ã —É—Å—Ç–∞—Ä–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–æ–≤—ã–µ –≤ use case
- `repository.go` - –≤ Event Sourcing –Ω–µ –Ω—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è EventStore

#### 2. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª:
```
‚úÖ aggregate.go ‚Üí task.go
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- Aggregate —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª—å—é –¥–ª—è Task
- –õ–æ–≥–∏—á–Ω–µ–µ –Ω–∞–∑—ã–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª `task.go`

#### 3. –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
internal/domain/task/
‚îú‚îÄ‚îÄ task.go           # Task Aggregate —Å Event Sourcing (–±—ã–ª–æ aggregate.go)
‚îú‚îÄ‚îÄ events.go         # –°–æ–±—ã—Ç–∏—è –¥–ª—è Event Sourcing
‚îî‚îÄ‚îÄ entity_state.go   # Value Object –¥–ª—è state machine (—Å—Ç–∞—Ç—É—Å—ã/–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

#### ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏:
- **–£–¥–∞–ª–µ–Ω–æ:** ~250 —Å—Ç—Ä–æ–∫ —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫–æ–¥–∞
- **–û—Å—Ç–∞–ª–æ—Å—å:** 720 —Å—Ç—Ä–æ–∫ —á–∏—Å—Ç–æ–≥–æ Event Sourcing –∫–æ–¥–∞
- **–¢–µ—Å—Ç—ã:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (7 test suites, 20+ tests)
- **–õ–∏–Ω—Ç–µ—Ä:** ‚úÖ 0 issues (golangci-lint)
- **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:** ‚úÖ –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è

#### ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **Single Source of Truth** - —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω Aggregate –¥–ª—è Task
2. **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
3. **Event Sourcing** - –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **CQRS ready** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é Command/Query
5. **–ê—É–¥–∏—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–∫—Ç–æ, –∫–æ–≥–¥–∞, —á—Ç–æ)

#### ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- üìù –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–¥–∞—á–∏
- ‚èÆÔ∏è Time-travel debugging (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª—é–±–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
- üë§ –ê—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (createdBy, changedBy)
- üîí Optimistic locking —á–µ—Ä–µ–∑ version tracking
- üîÑ Event replay –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- üìä Event-driven projections –¥–ª—è Read Models

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

#### –ß—Ç–æ –ù–ï —Å–ª–æ–º–∞–ª–æ—Å—å:
- ‚úÖ Use Cases —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ
- ‚úÖ CreateTaskUseCase –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–π Aggregate
- ‚úÖ EventStore –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

#### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:
- ‚ùå –°—Ç–∞—Ä—ã–π CRUD repository –±–æ–ª—å—à–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ –í–º–µ—Å—Ç–æ –Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è EventStore
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –±—É–¥—É—â–µ–≥–æ

–ö–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è **Read Models** (Query side –≤ CQRS):

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª `read_model.go` —Å –ø—Ä–æ–µ–∫—Ü–∏—è–º–∏
2. –ü—Ä–æ–µ–∫—Ü–∏–∏ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ Event Handlers
3. –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ –±–µ–∑ replay —Å–æ–±—ã—Ç–∏–π
4. Aggregate –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è Command side

```
Command Side (Write)        Query Side (Read)
====================       ===================
Task Aggregate      ‚Üí      Task Read Model
  ‚Üì Events                   ‚Üë Event Handlers
Event Store         ‚Üí      Projections Table
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞

```bash
# –ö–æ–º–ø–∏–ª—è—Ü–∏—è
‚úÖ go build ./...

# –¢–µ—Å—Ç—ã
‚úÖ go test ./internal/usecase/task/...
   PASS (7 tests, 0.006s)

# –õ–∏–Ω—Ç–µ—Ä
‚úÖ golangci-lint run ./internal/...
   0 issues

# –ü–æ–∫—Ä—ã—Ç–∏–µ
‚úÖ go test -cover ./internal/usecase/task/...
   coverage: 87.8%
```

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫:
1. ‚úÖ **Task 03:** ChangeStatusUseCase (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞)
2. ‚úÖ **Task 04:** AssignTaskUseCase (–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)
3. ‚úÖ **Task 05:** ChangePriority/SetDueDate UseCases
4. üìù **–ë—É–¥—É—â–µ–µ:** Read Models –∏ Projections –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –í—ã–≤–æ–¥—ã

**–ë—ã–ª–æ:**
```
task.go (Entity) ‚Üê CRUD
  ‚Üì
Database Table
```

**–°—Ç–∞–ª–æ:**
```
task.go (Aggregate) ‚Üê Event Sourcing
  ‚Üì
Event Store (append-only log)
```

‚úÖ **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–∞–ª–∞ —á–∏—â–µ, –ø—Ä–æ—â–µ –∏ –º–æ—â–Ω–µ–µ!**

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2025-10-18
**–í–µ—Ä—Å–∏—è:** 1.0
