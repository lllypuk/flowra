openapi: 3.1.0
info:
  title: Flowra API
  description: |
    Chat System with Task Management API.

    This API provides comprehensive functionality for:
    - User authentication (Keycloak SSO integration)
    - Workspace management with role-based access control
    - Real-time chat with participants management
    - Task management with kanban-style workflows
    - Message handling with attachments and reactions
    - Notification system
    - WebSocket real-time communication

    ## Authentication

    All endpoints (except `/auth/login` and `/auth/register`) require JWT authentication.
    Include the JWT token in the `Authorization` header:

    ```
    Authorization: Bearer <token>
    ```

    ## Rate Limiting

    - Default: 100 requests per minute per user
    - Auth endpoints: 10 requests per minute per IP
    - WebSocket: 60 messages per minute per connection

    ## Error Handling

    All errors follow a consistent format with `code` and `message` fields.
  version: 1.0.0
  contact:
    name: Flowra Development Team
    email: dev@flowra.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.flowra.com/api/v1
    description: Production server

security:
  - bearerAuth: []

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Users
    description: User profile management
  - name: Workspaces
    description: Workspace management and member operations
  - name: Chats
    description: Chat rooms and participant management
  - name: Messages
    description: Message operations within chats
  - name: Tasks
    description: Task management and workflow operations
  - name: Notifications
    description: User notification management
  - name: WebSocket
    description: Real-time communication endpoints

paths:
  # ============================================
  # Authentication Endpoints
  # ============================================
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login with OAuth code
      description: |
        Authenticates user using OAuth authorization code from Keycloak.
        Returns access and refresh tokens along with user information.
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            example:
              code: "authorization_code_from_keycloak"
              redirect_uri: "http://localhost:8080/callback"
      responses:
        "200":
          description: Successful authentication
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                success: false
                error:
                  code: "INVALID_CREDENTIALS"
                  message: "Invalid OAuth code or credentials"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout current session
      description: Invalidates the current session and refresh token
      operationId: logout
      responses:
        "200":
          description: Successfully logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "Logged out successfully"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: |
        Refreshes the access token using a valid refresh token.
        The endpoint accepts expired access tokens.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
            example:
              refresh_token: "refresh_token_here"
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          description: Invalid or expired refresh token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                success: false
                error:
                  code: "INVALID_REFRESH_TOKEN"
                  message: "Refresh token is invalid or expired"
        "500":
          $ref: "#/components/responses/InternalError"

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get current user
      description: Returns the currently authenticated user's information
      operationId: getCurrentUser
      responses:
        "200":
          description: Current user information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # User Endpoints
  # ============================================
  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Returns the full profile of the authenticated user
      operationId: getMyProfile
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetailResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

    put:
      tags:
        - Users
      summary: Update current user profile
      description: Updates the authenticated user's profile information
      operationId: updateMyProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProfileRequest"
            example:
              display_name: "John Doe"
              email: "john.doe@example.com"
      responses:
        "200":
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetailResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "409":
          description: Email or username already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                success: false
                error:
                  code: "EMAIL_EXISTS"
                  message: "Email is already in use"

  /users/{id}:
    get:
      tags:
        - Users
      summary: Get user by ID
      description: Returns a user's public profile by their ID
      operationId: getUserById
      parameters:
        - $ref: "#/components/parameters/UserIdPath"
      responses:
        "200":
          description: User profile
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetailResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Workspace Endpoints
  # ============================================
  /workspaces:
    get:
      tags:
        - Workspaces
      summary: List user workspaces
      description: Returns all workspaces the authenticated user is a member of
      operationId: listWorkspaces
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
      responses:
        "200":
          description: List of workspaces
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

    post:
      tags:
        - Workspaces
      summary: Create a new workspace
      description: Creates a new workspace with the authenticated user as owner
      operationId: createWorkspace
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateWorkspaceRequest"
            example:
              name: "My Team Workspace"
              description: "Workspace for team collaboration"
      responses:
        "201":
          description: Workspace created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

  /workspaces/{workspace_id}:
    get:
      tags:
        - Workspaces
      summary: Get workspace details
      description: Returns detailed information about a specific workspace
      operationId: getWorkspace
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      responses:
        "200":
          description: Workspace details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    put:
      tags:
        - Workspaces
      summary: Update workspace
      description: Updates workspace settings. Requires admin or owner role.
      operationId: updateWorkspace
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateWorkspaceRequest"
            example:
              name: "Updated Workspace Name"
              description: "Updated description"
      responses:
        "200":
          description: Workspace updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkspaceResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    delete:
      tags:
        - Workspaces
      summary: Delete workspace
      description: Permanently deletes a workspace. Requires owner role.
      operationId: deleteWorkspace
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      responses:
        "204":
          description: Workspace deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/members:
    post:
      tags:
        - Workspaces
      summary: Add member to workspace
      description: Adds a new member to the workspace. Requires admin role.
      operationId: addWorkspaceMember
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddMemberRequest"
            example:
              user_id: "550e8400-e29b-41d4-a716-446655440000"
              role: "member"
      responses:
        "201":
          description: Member added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemberResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "409":
          description: Member already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              example:
                success: false
                error:
                  code: "MEMBER_ALREADY_EXISTS"
                  message: "User is already a member of this workspace"

  /workspaces/{workspace_id}/members/{user_id}:
    delete:
      tags:
        - Workspaces
      summary: Remove member from workspace
      description: Removes a member from the workspace. Requires admin role.
      operationId: removeWorkspaceMember
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/UserIdPath"
      responses:
        "204":
          description: Member removed successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          description: Cannot remove owner or insufficient privileges
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/members/{user_id}/role:
    put:
      tags:
        - Workspaces
      summary: Update member role
      description: Updates a member's role in the workspace. Requires admin role.
      operationId: updateMemberRole
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/UserIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateMemberRoleRequest"
            example:
              role: "admin"
      responses:
        "200":
          description: Role updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MemberResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Chat Endpoints
  # ============================================
  /workspaces/{workspace_id}/chats:
    get:
      tags:
        - Chats
      summary: List chats in workspace
      description: Returns all chats the user has access to in the workspace
      operationId: listChats
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: type
          in: query
          description: Filter by chat type
          schema:
            type: string
            enum: [chat, task, bug, support]
        - name: status
          in: query
          description: Filter by status (for task/bug chats)
          schema:
            type: string
            enum: [open, in_progress, review, done, closed]
      responses:
        "200":
          description: List of chats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"

    post:
      tags:
        - Chats
      summary: Create a new chat
      description: Creates a new chat or task in the workspace
      operationId: createChat
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateChatRequest"
            example:
              name: "Project Discussion"
              type: "chat"
              is_public: true
              participant_ids:
                - "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "201":
          description: Chat created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"

  /workspaces/{workspace_id}/chats/{chat_id}:
    get:
      tags:
        - Chats
      summary: Get chat details
      description: Returns detailed information about a specific chat
      operationId: getChat
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
      responses:
        "200":
          description: Chat details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    put:
      tags:
        - Chats
      summary: Update chat
      description: Updates chat settings. Requires chat admin role.
      operationId: updateChat
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateChatRequest"
            example:
              name: "Updated Chat Name"
      responses:
        "200":
          description: Chat updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    delete:
      tags:
        - Chats
      summary: Delete chat
      description: Deletes a chat. Requires chat creator or workspace admin.
      operationId: deleteChat
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
      responses:
        "204":
          description: Chat deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/chats/{chat_id}/participants:
    post:
      tags:
        - Chats
      summary: Add participant to chat
      description: Adds a user as a participant to the chat
      operationId: addChatParticipant
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddParticipantRequest"
            example:
              user_id: "550e8400-e29b-41d4-a716-446655440000"
              role: "member"
      responses:
        "201":
          description: Participant added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ParticipantResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "409":
          description: User is already a participant
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /workspaces/{workspace_id}/chats/{chat_id}/participants/{user_id}:
    delete:
      tags:
        - Chats
      summary: Remove participant from chat
      description: Removes a participant from the chat
      operationId: removeChatParticipant
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
        - $ref: "#/components/parameters/UserIdPath"
      responses:
        "204":
          description: Participant removed successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Message Endpoints
  # ============================================
  /workspaces/{workspace_id}/chats/{chat_id}/messages:
    get:
      tags:
        - Messages
      summary: List messages in chat
      description: Returns messages in a chat with pagination
      operationId: listMessages
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: before
          in: query
          description: Get messages before this message ID (cursor-based pagination)
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    post:
      tags:
        - Messages
      summary: Send a message
      description: Sends a new message to the chat
      operationId: sendMessage
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/ChatIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SendMessageRequest"
            example:
              content: "Hello, team! Let's discuss the project."
              reply_to_id: null
      responses:
        "201":
          description: Message sent successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /messages/{message_id}:
    put:
      tags:
        - Messages
      summary: Edit a message
      description: Edits a message. Only the author can edit their message.
      operationId: editMessage
      parameters:
        - $ref: "#/components/parameters/MessageIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EditMessageRequest"
            example:
              content: "Updated message content"
      responses:
        "200":
          description: Message edited successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          description: Only the message author can edit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          $ref: "#/components/responses/NotFoundError"

    delete:
      tags:
        - Messages
      summary: Delete a message
      description: Soft-deletes a message. Only the author or chat admin can delete.
      operationId: deleteMessage
      parameters:
        - $ref: "#/components/parameters/MessageIdPath"
      responses:
        "204":
          description: Message deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Task Endpoints
  # ============================================
  /workspaces/{workspace_id}/tasks:
    get:
      tags:
        - Tasks
      summary: List tasks in workspace
      description: Returns all tasks the user has access to in the workspace
      operationId: listTasks
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: status
          in: query
          description: Filter by status
          schema:
            type: string
            enum: [todo, in_progress, review, done, cancelled]
        - name: assignee_id
          in: query
          description: Filter by assignee
          schema:
            type: string
            format: uuid
        - name: priority
          in: query
          description: Filter by priority
          schema:
            type: string
            enum: [low, medium, high, critical]
        - name: entity_type
          in: query
          description: Filter by entity type
          schema:
            type: string
            enum: [task, bug, feature, support]
      responses:
        "200":
          description: List of tasks
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"

    post:
      tags:
        - Tasks
      summary: Create a new task
      description: Creates a new task in the workspace
      operationId: createTask
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTaskRequest"
            example:
              title: "Implement user authentication"
              description: "Add login/logout functionality"
              priority: "high"
              assignee_id: "550e8400-e29b-41d4-a716-446655440000"
              due_date: "2026-02-15T00:00:00Z"
              entity_type: "task"
      responses:
        "201":
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"

  /workspaces/{workspace_id}/tasks/{task_id}:
    get:
      tags:
        - Tasks
      summary: Get task details
      description: Returns detailed information about a specific task
      operationId: getTask
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      responses:
        "200":
          description: Task details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

    delete:
      tags:
        - Tasks
      summary: Delete task
      description: Deletes a task
      operationId: deleteTask
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      responses:
        "204":
          description: Task deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/tasks/{task_id}/status:
    put:
      tags:
        - Tasks
      summary: Change task status
      description: Changes the status of a task
      operationId: changeTaskStatus
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangeStatusRequest"
            example:
              status: "in_progress"
      responses:
        "200":
          description: Status changed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          description: Invalid status transition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/tasks/{task_id}/assignee:
    put:
      tags:
        - Tasks
      summary: Assign task
      description: Assigns a task to a user
      operationId: assignTask
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignTaskRequest"
            example:
              assignee_id: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        "200":
          description: Task assigned successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/tasks/{task_id}/priority:
    put:
      tags:
        - Tasks
      summary: Change task priority
      description: Changes the priority of a task
      operationId: changeTaskPriority
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePriorityRequest"
            example:
              priority: "critical"
      responses:
        "200":
          description: Priority changed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  /workspaces/{workspace_id}/tasks/{task_id}/due-date:
    put:
      tags:
        - Tasks
      summary: Set task due date
      description: Sets or updates the due date of a task
      operationId: setTaskDueDate
      parameters:
        - $ref: "#/components/parameters/WorkspaceIdPath"
        - $ref: "#/components/parameters/TaskIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetDueDateRequest"
            example:
              due_date: "2026-02-28T23:59:59Z"
      responses:
        "200":
          description: Due date set successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"
        "400":
          $ref: "#/components/responses/ValidationError"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "403":
          $ref: "#/components/responses/ForbiddenError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Notification Endpoints
  # ============================================
  /notifications:
    get:
      tags:
        - Notifications
      summary: List notifications
      description: Returns notifications for the authenticated user
      operationId: listNotifications
      parameters:
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - name: unread_only
          in: query
          description: Return only unread notifications
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: List of notifications
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationListResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

  /notifications/unread/count:
    get:
      tags:
        - Notifications
      summary: Get unread notification count
      description: Returns the count of unread notifications
      operationId: getUnreadCount
      responses:
        "200":
          description: Unread notification count
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnreadCountResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

  /notifications/{id}/read:
    put:
      tags:
        - Notifications
      summary: Mark notification as read
      description: Marks a specific notification as read
      operationId: markNotificationAsRead
      parameters:
        - $ref: "#/components/parameters/NotificationIdPath"
      responses:
        "200":
          description: Notification marked as read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NotificationResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"
        "409":
          description: Notification is already read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /notifications/mark-all-read:
    put:
      tags:
        - Notifications
      summary: Mark all notifications as read
      description: Marks all notifications as read for the current user
      operationId: markAllNotificationsAsRead
      responses:
        "200":
          description: All notifications marked as read
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MarkAllReadResponse"
        "401":
          $ref: "#/components/responses/UnauthorizedError"

  /notifications/{id}:
    delete:
      tags:
        - Notifications
      summary: Delete notification
      description: Deletes a specific notification
      operationId: deleteNotification
      parameters:
        - $ref: "#/components/parameters/NotificationIdPath"
      responses:
        "204":
          description: Notification deleted successfully
        "401":
          $ref: "#/components/responses/UnauthorizedError"
        "404":
          $ref: "#/components/responses/NotFoundError"

  # ============================================
  # Health Check Endpoints
  # ============================================
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the API
      operationId: healthCheck
      security: []
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"

  /ready:
    get:
      tags:
        - Health
      summary: Readiness check
      description: Returns whether the service is ready to accept traffic
      operationId: readinessCheck
      security: []
      responses:
        "200":
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ready"
                  components:
                    type: object
                    additionalProperties:
                      type: object
                      properties:
                        status:
                          type: string
                          example: "healthy"
        "503":
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "not ready"

  # ============================================
  # WebSocket Endpoint
  # ============================================
  /ws:
    get:
      tags:
        - WebSocket
      summary: WebSocket connection
      description: |
        Establishes a WebSocket connection for real-time updates.

        Authentication can be provided via:
        - Query parameter: `?token=<jwt_token>`
        - Authorization header: `Authorization: Bearer <token>`

        ## Message Types

        ### Client to Server
        - `subscribe_chat` - Subscribe to chat updates
        - `unsubscribe_chat` - Unsubscribe from chat updates
        - `subscribe_workspace` - Subscribe to workspace updates
        - `typing` - Send typing indicator
        - `ping` - Keepalive ping

        ### Server to Client
        - `message_posted` - New message in subscribed chat
        - `message_edited` - Message was edited
        - `message_deleted` - Message was deleted
        - `task_updated` - Task was updated
        - `user_typing` - User is typing in chat
        - `user_joined` - User joined chat
        - `user_left` - User left chat
        - `notification` - New notification
        - `error` - Error message
        - `pong` - Keepalive response
      operationId: websocketConnect
      parameters:
        - name: token
          in: query
          description: JWT access token
          schema:
            type: string
      responses:
        "101":
          description: WebSocket connection established
        "401":
          $ref: "#/components/responses/UnauthorizedError"

components:
  # ============================================
  # Security Schemes
  # ============================================
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login

  # ============================================
  # Parameters
  # ============================================
  parameters:
    WorkspaceIdPath:
      name: workspace_id
      in: path
      required: true
      description: Workspace ID
      schema:
        type: string
        format: uuid

    ChatIdPath:
      name: chat_id
      in: path
      required: true
      description: Chat ID
      schema:
        type: string
        format: uuid

    UserIdPath:
      name: user_id
      in: path
      required: true
      description: User ID
      schema:
        type: string
        format: uuid

    MessageIdPath:
      name: message_id
      in: path
      required: true
      description: Message ID
      schema:
        type: string
        format: uuid

    TaskIdPath:
      name: task_id
      in: path
      required: true
      description: Task ID
      schema:
        type: string
        format: uuid

    NotificationIdPath:
      name: id
      in: path
      required: true
      description: Notification ID
      schema:
        type: string
        format: uuid

    Limit:
      name: limit
      in: query
      description: Maximum number of results to return
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

    Offset:
      name: offset
      in: query
      description: Number of results to skip
      schema:
        type: integer
        minimum: 0
        default: 0

  # ============================================
  # Responses
  # ============================================
  responses:
    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error:
              code: "UNAUTHORIZED"
              message: "Authentication required"

    ForbiddenError:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error:
              code: "FORBIDDEN"
              message: "You don't have permission to perform this action"

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error:
              code: "NOT_FOUND"
              message: "Resource not found"

    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error:
              code: "VALIDATION_ERROR"
              message: "Invalid request data"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            success: false
            error:
              code: "INTERNAL_ERROR"
              message: "An unexpected error occurred"

  # ============================================
  # Schemas
  # ============================================
  schemas:
    # Error schemas
    Error:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "Invalid request data"
            details:
              type: object
              description: Additional error details
              additionalProperties:
                type: string

    # Authentication schemas
    LoginRequest:
      type: object
      required:
        - code
        - redirect_uri
      properties:
        code:
          type: string
          description: OAuth authorization code from Keycloak
        redirect_uri:
          type: string
          description: Redirect URI used in the OAuth flow

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            access_token:
              type: string
              description: JWT access token
            refresh_token:
              type: string
              description: Refresh token for obtaining new access tokens
            expires_in:
              type: integer
              description: Token expiration time in seconds
              example: 900
            user:
              $ref: "#/components/schemas/UserDTO"

    RefreshRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: Valid refresh token

    RefreshResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            access_token:
              type: string
              description: New JWT access token
            refresh_token:
              type: string
              description: New refresh token
            expires_in:
              type: integer
              description: Token expiration time in seconds

    # User schemas
    UserDTO:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        username:
          type: string
        display_name:
          type: string
        avatar_url:
          type: string
          format: uri

    UserResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: "#/components/schemas/UserDTO"

    UserDetailResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            username:
              type: string
            email:
              type: string
              format: email
            display_name:
              type: string
            avatar_url:
              type: string
              format: uri
            is_admin:
              type: boolean
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    UpdateProfileRequest:
      type: object
      properties:
        display_name:
          type: string
          maxLength: 100
        email:
          type: string
          format: email
        avatar_url:
          type: string
          format: uri
          maxLength: 500

    # Workspace schemas
    CreateWorkspaceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        description:
          type: string
          maxLength: 500

    UpdateWorkspaceRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        description:
          type: string
          maxLength: 500

    WorkspaceResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            name:
              type: string
            description:
              type: string
            owner_id:
              type: string
              format: uuid
            member_count:
              type: integer
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    WorkspaceListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            workspaces:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  description:
                    type: string
                  owner_id:
                    type: string
                    format: uuid
                  member_count:
                    type: integer
                  created_at:
                    type: string
                    format: date-time
                  updated_at:
                    type: string
                    format: date-time
            total:
              type: integer
            offset:
              type: integer
            limit:
              type: integer

    AddMemberRequest:
      type: object
      required:
        - user_id
        - role
      properties:
        user_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [member, admin]

    UpdateMemberRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [member, admin]

    MemberResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            user_id:
              type: string
              format: uuid
            username:
              type: string
            email:
              type: string
              format: email
            role:
              type: string
              enum: [owner, admin, member]
            joined_at:
              type: string
              format: date-time

    # Chat schemas
    CreateChatRequest:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        type:
          type: string
          enum: [chat, task, bug, support]
        is_public:
          type: boolean
          default: false
        participant_ids:
          type: array
          items:
            type: string
            format: uuid

    UpdateChatRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100

    ChatResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            workspace_id:
              type: string
              format: uuid
            name:
              type: string
            type:
              type: string
              enum: [chat, task, bug, support]
            is_public:
              type: boolean
            created_by:
              type: string
              format: uuid
            created_at:
              type: string
              format: date-time
            participants:
              type: array
              items:
                $ref: "#/components/schemas/ParticipantInfo"
            status:
              type: string
              description: For task/bug chats
              enum: [open, in_progress, review, done, closed]
            assigned_to:
              type: string
              format: uuid
              description: For task/bug chats
            priority:
              type: string
              description: For task chats
              enum: [low, medium, high, critical]
            due_date:
              type: string
              format: date-time
              description: For task chats

    ChatListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            chats:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  workspace_id:
                    type: string
                    format: uuid
                  name:
                    type: string
                  type:
                    type: string
                  is_public:
                    type: boolean
                  created_at:
                    type: string
                    format: date-time
                  status:
                    type: string
                  priority:
                    type: string
            total:
              type: integer
            has_more:
              type: boolean

    AddParticipantRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [member, admin]
          default: member

    ParticipantInfo:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        role:
          type: string
          enum: [member, admin]
        joined_at:
          type: string
          format: date-time

    ParticipantResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: "#/components/schemas/ParticipantInfo"

    # Message schemas
    SendMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 10000
        reply_to_id:
          type: string
          format: uuid
          description: ID of the message being replied to

    EditMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 10000

    MessageResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            chat_id:
              type: string
              format: uuid
            sender_id:
              type: string
              format: uuid
            content:
              type: string
            reply_to_id:
              type: string
              format: uuid
            created_at:
              type: string
              format: date-time
            edited_at:
              type: string
              format: date-time
            is_deleted:
              type: boolean
            attachments:
              type: array
              items:
                type: object
                properties:
                  file_id:
                    type: string
                    format: uuid
                  file_name:
                    type: string
                  file_size:
                    type: integer
                  mime_type:
                    type: string
            reactions:
              type: array
              items:
                type: object
                properties:
                  emoji:
                    type: string
                  users:
                    type: array
                    items:
                      type: string
                      format: uuid
                  count:
                    type: integer

    MessageListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            messages:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  chat_id:
                    type: string
                    format: uuid
                  sender_id:
                    type: string
                    format: uuid
                  content:
                    type: string
                  reply_to_id:
                    type: string
                    format: uuid
                  created_at:
                    type: string
                    format: date-time
                  edited_at:
                    type: string
                    format: date-time
                  is_deleted:
                    type: boolean
            has_more:
              type: boolean
            next_cursor:
              type: string

    # Task schemas
    CreateTaskRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 5000
        priority:
          type: string
          enum: [low, medium, high, critical]
          default: medium
        assignee_id:
          type: string
          format: uuid
        due_date:
          type: string
          format: date-time
        chat_id:
          type: string
          format: uuid
          description: Associated chat ID
        entity_type:
          type: string
          enum: [task, bug, feature, support]
          default: task

    ChangeStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [todo, in_progress, review, done, cancelled]

    AssignTaskRequest:
      type: object
      required:
        - assignee_id
      properties:
        assignee_id:
          type: string
          format: uuid
          description: User ID to assign the task to. Use null to unassign.

    ChangePriorityRequest:
      type: object
      required:
        - priority
      properties:
        priority:
          type: string
          enum: [low, medium, high, critical]

    SetDueDateRequest:
      type: object
      required:
        - due_date
      properties:
        due_date:
          type: string
          format: date-time
          description: Due date. Use null to remove the due date.

    TaskResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            chat_id:
              type: string
              format: uuid
            title:
              type: string
            description:
              type: string
            status:
              type: string
              enum: [todo, in_progress, review, done, cancelled]
            priority:
              type: string
              enum: [low, medium, high, critical]
            entity_type:
              type: string
              enum: [task, bug, feature, support]
            assignee_id:
              type: string
              format: uuid
            reporter_id:
              type: string
              format: uuid
            due_date:
              type: string
              format: date-time
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            version:
              type: integer

    TaskListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            tasks:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  chat_id:
                    type: string
                    format: uuid
                  title:
                    type: string
                  status:
                    type: string
                  priority:
                    type: string
                  entity_type:
                    type: string
                  assignee_id:
                    type: string
                    format: uuid
                  due_date:
                    type: string
                    format: date-time
                  created_at:
                    type: string
                    format: date-time
            total:
              type: integer
            has_more:
              type: boolean

    # Notification schemas
    NotificationResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
            type:
              type: string
              enum:
                [
                  task_status_changed,
                  task_assigned,
                  task_created,
                  chat_mention,
                  chat_message,
                  workspace_invite,
                  system,
                ]
            title:
              type: string
            body:
              type: string
            is_read:
              type: boolean
            resource_id:
              type: string
            link:
              type: string
            created_at:
              type: string
              format: date-time
            read_at:
              type: string
              format: date-time

    NotificationListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            notifications:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  type:
                    type: string
                  title:
                    type: string
                  body:
                    type: string
                  is_read:
                    type: boolean
                  resource_id:
                    type: string
                  link:
                    type: string
                  created_at:
                    type: string
                    format: date-time
                  read_at:
                    type: string
                    format: date-time
            total:
              type: integer
            has_more:
              type: boolean

    UnreadCountResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            count:
              type: integer
              example: 5

    MarkAllReadResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            marked_count:
              type: integer
              description: Number of notifications marked as read
              example: 10
