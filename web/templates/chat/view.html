{{define "chat/view"}}
<div class="chat-view" id="chat-{{.Data.Chat.ID}}">
    <!-- Chat Header -->
    <header class="chat-header">
        <div class="chat-title">
            <h2>{{.Data.Chat.Title}}</h2>
            {{if .Data.Chat.IsTaskChat}}
            {{with .Data.Task}}
            {{$status := .Status}}
            <span class="status-badge {{if eq $status "To Do"}}status-todo{{else if eq $status "In Progress"}}status-in_progress{{else if eq $status "In Review"}}status-review{{else if eq $status "Done"}}status-done{{else if eq $status "Backlog"}}status-backlog{{else if eq $status "Cancelled"}}status-cancelled{{else}}status-{{$status | lower}}{{end}}" id="chat-header-status">
                {{$status}}
            </span>
            {{else}}
            <span class="status-badge status-{{$.Data.Chat.Status | lower}}" id="chat-header-status">
                {{$.Data.Chat.Status}}
            </span>
            {{end}}
            {{end}}
        </div>

        <div class="chat-actions">
            <button
                hx-get="/partials/chats/{{.Data.Chat.ID}}/participants"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                class="outline small"
                title="Participants"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                {{.Data.Chat.ParticipantCount}}
            </button>
        </div>
    </header>

    <!-- Messages Container -->
    <div
        class="messages-container"
        id="messages-{{.Data.Chat.ID}}"
        hx-get="/partials/chats/{{.Data.Chat.ID}}/messages"
        hx-trigger="load"
        hx-swap="innerHTML"
    >
        {{template "loading" (dict "ID" "messages-loading")}}
    </div>

    <!-- Typing Indicator -->
    <div
        id="typing-indicator-{{.Data.Chat.ID}}"
        class="typing-indicator hidden"
    >
        <span class="typing-dots">
            <span></span><span></span><span></span>
        </span>
        <span id="typing-users"></span> is typing...
    </div>

    <!-- Message Input -->
    {{template "message_form" .}}
</div>

<script>
    // Subscribe to chat via WebSocket on load
    (function () {
        // Find WebSocket connection
        var wsElements = document.querySelectorAll('[hx-ext*="ws"]');
        if (wsElements.length > 0) {
            // Wait a bit for WebSocket to connect
            setTimeout(function () {
                for (var i = 0; i < wsElements.length; i++) {
                    var ws = wsElements[i].__htmx_ws;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(
                            JSON.stringify({
                                type: "subscribe",
                                chat_id: "{{.Data.Chat.ID}}",
                            }),
                        );
                        console.log("Subscribed to chat:", "{{.Data.Chat.ID}}");
                        break;
                    }
                }
            }, 500);
        }
    })();

    // Scroll to bottom on load
    document.addEventListener("htmx:afterSwap", function (evt) {
        if (evt.detail.target.id === "messages-{{.Data.Chat.ID}}") {
            scrollToBottom("messages-{{.Data.Chat.ID}}");
        }
    });

    // Handle incoming WebSocket messages
    document.body.addEventListener("chat.message.posted", function (evt) {
        var msg = evt.detail;
        if (msg.chat_id === "{{.Data.Chat.ID}}") {
            htmx.ajax("GET", "/partials/messages/" + msg.message_id, {
                target: "#messages-{{.Data.Chat.ID}}",
                swap: "beforeend",
            }).then(function () {
                scrollToBottom("messages-{{.Data.Chat.ID}}");
            });
        }
    });

    // Handle message edited
    document.body.addEventListener("chat.message.edited", function (evt) {
        var msg = evt.detail;
        var el = document.getElementById("message-" + msg.message_id);
        if (el) {
            htmx.ajax("GET", "/partials/messages/" + msg.message_id, {
                target: "#message-" + msg.message_id,
                swap: "outerHTML",
            });
        }
    });

    // Handle message deleted
    document.body.addEventListener("chat.message.deleted", function (evt) {
        var msg = evt.detail;
        var el = document.getElementById("message-" + msg.message_id);
        if (el) {
            el.remove();
        }
    });

    // Handle typing indicator
    document.body.addEventListener("chat.typing", function (evt) {
        var data = evt.detail;
        if (
            data.chat_id === "{{.Data.Chat.ID}}" &&
            data.user_id !== "{{.User.ID}}"
        ) {
            showTypingIndicator(data.username, "{{.Data.Chat.ID}}");
        }
    });
</script>

<style>
    .chat-view {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0; /* Required for nested flex to respect parent constraints */
        overflow: hidden; /* Prevent overflow */
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--muted-border-color);
        background: var(--card-background-color);
        flex-shrink: 0; /* Prevent header from shrinking */
    }

    .chat-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chat-title h2 {
        margin: 0;
        font-size: 1.25rem;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.status-todo {
        background: var(--secondary-focus);
        color: var(--secondary);
    }

    .status-badge.status-in_progress,
    .status-badge.status-in-progress {
        background: #e3f2fd;
        color: #1976d2;
    }

    .status-badge.status-review {
        background: #fff3e0;
        color: #f57c00;
    }

    .status-badge.status-done {
        background: #e8f5e9;
        color: #388e3c;
    }

    .chat-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chat-actions button {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-bottom: 0;
    }

    .messages-container {
        flex: 1;
        min-height: 0; /* Required for flex item to shrink and allow scrolling */
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        color: var(--muted-color);
        flex-shrink: 0; /* Prevent typing indicator from shrinking */
    }

    .typing-indicator.hidden {
        display: none;
    }

    .typing-dots {
        display: flex;
        gap: 2px;
    }

    .typing-dots span {
        width: 6px;
        height: 6px;
        background: var(--muted-color);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {
        0%,
        80%,
        100% {
            transform: scale(0.6);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
{{end}}
